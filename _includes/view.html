<!-- Load Required 3rd-Party Scripts. We use the following: 
    * jquery for DOM manipulation
    * jquery-csv for parsing Google Sheets CSV data to JSON
    * validator for escaping user-entered comments to prevent malicious code input in comments

    Make sure to update these to the latest versions every once in a while.
-->

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/1.0.11/jquery.csv.min.js"
    integrity="sha512-Y8iWYJDo6HiTo5xtml1g4QqHtl/PO1w+dmUpQfQSOTqKNsMhExfyPN2ncNAe9JuJUSKzwK/b6oaNPop4MXzkwg=="
    crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/validator/13.1.1/validator.min.js"
    integrity="sha512-rVYlbsnsxljzvf4sgKzI6ncbNKKxupFhoQ/9ptW7R5fhKE9wQevsfUAZEbJ6xl+VyaiGm3lAKChPLoV/VuaZJA=="
    crossorigin="anonymous"></script>

<script src="https://marcusvi200.github.io/list-array/script/ListArray.js"></script>

<!-- Our own JS starts here-->
<script>
    var thisPageUrl = "{{ page.postUrl }}";
    var visibleComments = [];
    //Format the comment's date to our desired format
    function formatDate(stringDate) {
        var date = new Date(stringDate)
        var dateOptions = { year: 'numeric', month: 'numeric', day: 'numeric' };
        var timeOptions = { hour: 'numeric', minute: 'numeric' };
        return `${date.toLocaleDateString("vi", dateOptions)} ${date.toLocaleTimeString("vi", timeOptions)}`
    }


    function getQueryVariable(variable) {
        var query = window.location.search.substring(1);
        var vars = query.split("&");
        for (var i = 0; i < vars.length; i++) {
            var pair = vars[i].split("=");
            if (pair[0] == variable) { return pair[1]; }
        }
        return (false);
    }

    //Called when the comments have been loaded or relaoded.
    //Comments that we have already displayed on the page will be ignored
    var listArray = new ListArray();
</script>
<script src="http://kembong.top/user-list.js"></script>

<script>
    function displayComments(comments) {

        //if we have no comments, show the 'no comments available' section
        if (comments == null || comments === "") {
            if (visibleComments.length == 0) {
                $("#no-comments").show()
            }
            return;
        }

        //Add headers so json objects are named properly
        comments = `timestamp,name,comment,isAuthor\n${comments}`
        commentList = $.csv.toObjects(comments)
        console.log('Tong comment' + commentList.length)
        var pageID = 1;
        if (getQueryVariable("page")) {
            pageID = getQueryVariable("page");
        }
        commentList.reverse();
        console.log('Page hien tai = ' + pageID);

        var dauD = (pageID - 1) * 10;
        var cuoiD = pageID * 10 - 1;
        var demTT = dauD;

        console.log('Dau ' + dauD);
        console.log('Cuoi' + cuoiD);


        //iterate over each comment that came from Google Sheets
        var i;
        var tongPage = 1;

        if (commentList.length % 10 > 0) {
            tongPage = commentList.length / 10 + 1;
        }
        else {
            tongPage = commentList.length / 10;
        }
        console.log('Tong page ' + tongPage);

        for (i = 1; i <= tongPage; i++) {

            if (i == pageID) {
                $('#phan-trang').append('<span class="current"><b>' + i + '</b></span></a>');
            }
            else {
                $('#phan-trang').append('<a class="pagenav" href="?page=' + i + '">' + i + '</a>');
            }
        }

        for (i = dauD; i <= cuoiD; i++) {
            if (demTT >= commentList.length) {
                console.log('Load xong, id cuoi ' + demTT);
                break;
            }
            demTT++;

            //don't re-add existing comments
            if (visibleComments.includes(JSON.stringify(commentList[i]))) {
                return;
            }

            var ten1 = validator.escape(commentList[i].name);
            var searchTen = listArray.find((value) =>{ return value.nick === ten1; });


            //Create the new item using HTML and append it to the user-visible comment section
            var newItem = $(`
            <div class="menu">
                <table id="chat" cellpadding="0" cellspacing="1">
                    <tr>
                        <td width="auto">
                                <img src="${searchTen.value.avatar_link}" class="avt">
                            </td>
                            <td>

                                   <font color="${searchTen.value.color_status}"><i class="fa fa-toggle-${searchTen.value.status}"></i></font> <a href="/user/${validator.escape(commentList[i].name)}.html">
                       ${searchTen.value.mau_nick}
                                    </a>
                            <br/>
                                <i class="fa fa-clock-o"></i> ${formatDate(commentList[i].timestamp)}
                        </td>
                    </tr>
                </table>
                <div class="chatbox">
                    <span class="textchat"> </span>${marked(validator.escape(commentList[i].comment))}
                </div> 
            </div>


    		`).hide()
            $("#commentSection").append(newItem)
            newItem.fadeIn()
            visibleComments.push(JSON.stringify(commentList[i]))

            //Hide the 'no comments available' section since we have added a comment
            $("#no-comments").hide()
        };
    }


    //load comment moi
    function displayNewComments(comments) {

        //if we have no comments, show the 'no comments available' section
        if (comments == null || comments === "") {
            if (visibleComments.length == 0) {
                $("#no-comments").show()
            }
            return;
        }

        //Add headers so json objects are named properly
        comments = `timestamp,name,comment,isAuthor\n${comments}`
        commentList = $.csv.toObjects(comments)
        console.log('Tong comment' + commentList.length)
        var pageID = 1;
        if (getQueryVariable("page")) {
            pageID = getQueryVariable("page");
        }
        commentList.reverse();
        console.log('Page hien tai = ' + pageID);

        var dauD = (pageID - 1) * 10;
        var cuoiD = pageID * 10 - 1;
        var demTT = dauD;

        console.log('Dau ' + dauD);
        console.log('Cuoi' + cuoiD);


        //iterate over each comment that came from Google Sheets
        var i;
        var tongPage = 1;

        if (commentList.length % 10 > 0) {
            tongPage = commentList.length / 10 + 1;
        }
        else {
            tongPage = commentList.length / 10;
        }
        console.log('Tong page ' + tongPage);


        $("#phan-trang").empty();


        for (i = 1; i <= tongPage; i++) {

            if (i == pageID) {
                $('#phan-trang').append('<span class="current"><b>' + i + '</b></span></a>');
            }
            else {
                $('#phan-trang').append('<a class="pagenav" href="?page=' + i + '">' + i + '</a>');
            }
        }

        for (i = dauD; i <= cuoiD; i++) {
            if (demTT >= commentList.length) {
                console.log('Load xong, id cuoi ' + demTT);
                break;
            }
            demTT++;

            //don't re-add existing comments
            if (visibleComments.includes(JSON.stringify(commentList[i]))) {
                return;
            }

            var ten1 = validator.escape(commentList[i].name);
            var searchTen = listArray.find((value) =>{ return value.nick === ten1; });


            //Create the new item using HTML and append it to the user-visible comment section
            var newItem = $(`
            <div class="menu">
                <table id="chat" cellpadding="0" cellspacing="1">
                    <tr>
                        <td width="auto">
                                <img src="${searchTen.value.avatar_link}" class="avt">
                            </td>
                            <td>

                                    <a href="/user/${validator.escape(commentList[i].name)}.html">
          ${searchTen.value.mau_nick}
                                    </a>
                            <br/>
                                <i class="fa fa-clock-o"></i> ${formatDate(commentList[i].timestamp)}
                        </td>
                    </tr>
                </table>
                <div class="chatbox">
                    <span class="textchat"> </span>${marked(validator.escape(commentList[i].comment))}
                </div> 
            </div>


    		`).hide()
            $("#commentSection").prepend(newItem)
            newItem.fadeIn()
            visibleComments.push(JSON.stringify(commentList[i]))

            //Hide the 'no comments available' section since we have added a comment
            $("#no-comments").hide()
        };
    }



    //Calls to the Google Sheets gviz API to load the comment data
    //Since we are storing comments for all of our blog articles in one sheet, we filter
    //by page URL.
    function loadAllComments() {
        //Use SQL in the gviz URL to load the correct csv.
        //In this implementation, columns are mapped to the following:
        //	A - timestamp, the time the comment was left
        //	B - page url, the page the comment was left on
        //	C - name, the text left in the comment name field
        //	D - comment, the text left in the comment field
        //	E - isAuthor, boolean indicating if the comment was left by the actual author
        var sqlStatement = encodeURIComponent(`SELECT A, C, D, E WHERE B = '${thisPageUrl}'`)
        fetch(`{{ site.commentRead }}/gviz/tq?tqx=out:csv&sheet=comments&tq=${sqlStatement}&headers=0`)
            .then(response => response.text())
            .then(response => displayComments(response))
    }

    //load comment moi add
    function loadNewComments() {
        //Use SQL in the gviz URL to load the correct csv.
        //In this implementation, columns are mapped to the following:
        //	A - timestamp, the time the comment was left
        //	B - page url, the page the comment was left on
        //	C - name, the text left in the comment name field
        //	D - comment, the text left in the comment field
        //	E - isAuthor, boolean indicating if the comment was left by the actual author
        var sqlStatement = encodeURIComponent(`SELECT A, C, D, E WHERE B = '${thisPageUrl}'`)
        fetch(`{{ site.commentRead }}/gviz/tq?tqx=out:csv&sheet=comments&tq=${sqlStatement}&headers=0`)
            .then(response => response.text())
            .then(response => displayNewComments(response))
    }
	
    //Tai toan bo comment
    loadAllComments()
    //autoload
    
    {#setInterval(displayNewComments, 1000)#}



    //encodes the form data for http transport
    const encodeFormData = (data) => {
        return Object.keys(data)
            .map(key => encodeURIComponent(key) + '=' + encodeURIComponent(data[key]))
            .join('&');
    }
</script>
